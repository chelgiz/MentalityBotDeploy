import openai
from bot.config import OPENAI_API_KEY

openai.api_key = OPENAI_API_KEY

async def generate_diagnostic_summary(results: dict) -> str:
    prompt = (
        "–¢—ã ‚Äî –ú–∏—è, —ç–º–ø–∞—Ç–∏—á–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª —Å–µ—Ä–∏—é —Ç–µ—Å—Ç–æ–≤ –ø–æ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é. "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞:\n"
        "1. –í—ã–¥–∞—Ç—å –º—è–≥–∫—É—é –∏ —á–µ–ª–æ–≤–µ—á–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n"
        "2. –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ ‚Äî –±–µ—Ä–µ–∂–Ω–æ –∏ –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è\n"
        "3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–±–µ–∑ –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏—è)\n"
        "4. –ù–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑—ã, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—É–≥–∞—é—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã\n"
        "5. –ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–∞–∫ –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫, –Ω–æ —Å –≥–ª—É–±–∏–Ω–æ–π\n\n"
        f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
        f"- PHQ-9 (–¥–µ–ø—Ä–µ—Å—Å–∏—è): {results.get('phq9', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')} –±–∞–ª–ª–æ–≤\n"
        f"- –ë–µ–∫: {results.get('beck', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')} –±–∞–ª–ª–æ–≤\n"
        f"- –°–ø–∏–ª–±–µ—Ä–≥–µ—Ä (—Å–∏—Ç—É–∞—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å): {results.get('spilberger_state', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')} –±–∞–ª–ª–æ–≤\n"
        f"- –°–ø–∏–ª–±–µ—Ä–≥–µ—Ä (–ª–∏—á–Ω–æ—Å—Ç–Ω–∞—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å): {results.get('spilberger_trait', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')} –±–∞–ª–ª–æ–≤\n"
        f"- MFI-20 (–∞—Å—Ç–µ–Ω–∏—è): {results.get('mfi20', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')} –±–∞–ª–ª–æ–≤\n"
        f"- –í—ã–≥–æ—Ä–∞–Ω–∏–µ:\n"
        f"    ‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏—Å—Ç–æ—â–µ–Ω–∏–µ: {results.get('burnout_ee', '?')} –±–∞–ª–ª–æ–≤\n"
        f"    ‚Ä¢ –î–µ–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: {results.get('burnout_dp', '?')} –±–∞–ª–ª–æ–≤\n"
        f"    ‚Ä¢ –õ–∏—á–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è: {results.get('burnout_pa', '?')} –±–∞–ª–ª–æ–≤\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ 6‚Äì10 —Å—Ç—Ä–æ–∫. –í –∫–æ–Ω—Ü–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â—É—é –º—ã—Å–ª—å. –ù–µ –∑–∞–±—ã–≤–∞–π, —Ç—ã ‚Äî –ú–∏—è üåø"
    )

    response = openai.ChatCompletion.create(
        model="gpt-4",  # –∏–ª–∏ gpt-3.5-turbo, –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ GPT-4
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ –ø–æ –∏–º–µ–Ω–∏ –ú–∏—è."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.85
    )

    return response.choices[0].message.content.strip()
